<!DOCTYPE html><html prefix="og: http://ogp.me/ns#"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>무한 스크롤 뒤로가기 문제 해결 1 · freeseamew`s blog</title><meta name="description"><meta name="og:url" content="http://freeseamew.github.io/2017/12/02/meteor-Infinite-scroll-1/"><meta name="og:type" content="article"><meta name="og:title" content="무한 스크롤 뒤로가기 문제 해결 1"><meta name="og:description"><meta name="og:image" content="http://freeseamew.github.io/logo3.png"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><meta name="fb:app_id" content="1765163213798195"><link rel="search" type="application/opensearchdescription+xml" href="http://freeseamew.github.io/atom.xml" title="freeseamew`s blog"></head><body><div id="fb-root"></div><div class="wrap"><header><a class="logo-link" href="/"><img src="/logo3.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self">목록보기</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">무한 스크롤 뒤로가기 문제 해결 1</h1><div class="post-info"><div class="post-info-profile"><a href="https://github.com/freeseamew" target="_blank"><img src="/image/profile.png"></a></div><div class="post-info-details"><div class="post-categories"></div><div class="post-date">Dec 2, 2017\t</div></div></div><div class="post-share"><div class="fb-like" data-href="http://freeseamew.github.io/2017/12/02/meteor-Infinite-scroll-1/" data-layout="button_count" data-action="like" data-size="small" data-show-faces="true" data-share="false">                 </div><div class="fb-follow" data-href="https://www.facebook.com/freeseamew" data-layout="button_count" data-size="small" data-show-faces="true">   </div><div class="fb-save" data-uri="http://freeseamew.github.io/2017/12/02/meteor-Infinite-scroll-1/" data-size="small"></div></div><div class="post-content"><h3 id="0-강좌-소개"><a href="#0-강좌-소개" class="headerlink" title="0. 강좌 소개"></a>0. 강좌 소개</h3><p>무한 스크롤을 구현하다 보면 자연스럽게 만나게 되는 문제가 있는데 그것은 브라우저 뒤로가기 문제입니다. 실제로 이 문제 때문에 무한 스크롤에 대한 부정적인 의견을 보인 개발자들도 있고, 이들에 의해 무한스크롤에 대한 나름 의미 있는 비판도 있었습니다. 하지만 시간이 지나고, <code>www.discourse.org</code>와 같이 이 뒤로가기 문제를 해결한 서비스가 하나둘씩 나타나게 되고, 모바일 환경에서 사용자 들이 느끼는 직관성 때문에 무한스크롤은 가장 보편적인 페이징 기법으로 자리매김 하고 있는 것 같습니다. </p>
<p>Meteor를 본격적으로 사용해볼 생각을 하면서 저 역시 이 문제를 해결해야만 했습니다.<br>하지만 국내 문서를 이리저리 뒤져봤지만 이 문제를 깔끔하게 해결한 답은 아직 찾지 못했습니다. 그래도 Meteor 커뮤니티나, 혹은 Stack Overflow 등에 올라온 여러 내용들을 조합하고, 응용해서 나름 이 문제를 해결한 결과물을 만들게 되었습니다. 이 강좌는 이 무한스크롤에 대한 저의 삽질기가 되겠습니다. 1~4번까지는 무한스크롤을 만드는 방법에 관한 내용입니다. 그리고 마지막 5번은 무한스크롤의 문제점과 이 해결방법에 관한 내용입니다. 이미 무한스크롤을 사용하시는 분은 5번만 보셔도 상관 없을 것 같습니다.  </p>
<hr>
<h3 id="1-환결-설정"><a href="#1-환결-설정" class="headerlink" title="1. 환결 설정"></a>1. 환결 설정</h3><h4 id="1-1-폴더-구조"><a href="#1-1-폴더-구조" class="headerlink" title="1.1 폴더 구조"></a>1.1 폴더 구조</h4><p>자 그럼 본격적으로 강좌를 시작해 보겠습니다. </p>
<p>일단 Meteor에 대한 기본 설치는 다음 강좌를 참고해 주시기 바랍니다. 아래 강좌에서 설치에 대한 부분만 참고 하시면 되겠습니다.<br><a href="https://freeseamew.github.io/2017/07/02/meteor-account-tutorial-1/">https://freeseamew.github.io/2017/07/02/meteor-account-tutorial-1/</a></p>
<p>설치후에 다음과 같은 구조로 파일들을 만들어 주세요.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">meteorAccount</div><div class="line">├── .meteor</div><div class="line">├── client</div><div class="line">│   ├── styles  </div><div class="line">│   │    └── main.css </div><div class="line">│   ├── contents</div><div class="line">│   │    ├── post-lists.html</div><div class="line">│   │    ├── post-lists.js</div><div class="line">│   │    ├── post-view.html</div><div class="line">│   │    └── post-view.js</div><div class="line">│   ├── autoscroll.js</div><div class="line">│   ├── main-layout.html</div><div class="line">│   └── main-layout.js </div><div class="line">├── lib</div><div class="line">│   ├── methods</div><div class="line">│   │    └── postMethods.js</div><div class="line">│   ├── collections.js</div><div class="line">│   └── routes.js </div><div class="line">├── node_module</div><div class="line">├── public</div><div class="line">└── server</div><div class="line">    ├── fixture.js </div><div class="line">    └── pubs.js</div></pre></td></tr></table></figure>
<h4 id="1-2-설치-페키지"><a href="#1-2-설치-페키지" class="headerlink" title="1.2 설치 페키지"></a>1.2 설치 페키지</h4><p>이번 예제에 사용할 페키지들은 다음과 같습니다.<br>우선 라우터 관련 페키지를 설치해 주세요.</p>
<blockquote>
<p>설치 패키지 : 라우터 관련</p>
<ul>
<li>meteor add kadira:flow-router</li>
<li>meteor add arillo:flow-router-helpers</li>
<li>meteor add kadira:blaze-layout</li>
</ul>
</blockquote>
<p>다음은 Subscription 캐쉬 입니다. 이부분에 대해서는 강좌중에 설명드리도록 하겠습니다. </p>
<blockquote>
<p>설치 패키지 : Subscription 캐쉬</p>
<ul>
<li>meteor add meteorhacks:subs-manager</li>
<li>meteor add msavin:mongol</li>
</ul>
</blockquote>
<p>마지막으로 템플릿에 사용할 bootstrap 관련 패키지를 설치하면 기본 설정은 끝입니다. </p>
<blockquote>
<p>설치 패키지 : 기타</p>
<ul>
<li>meteor add twbs:bootstrap@=3.3.6</li>
</ul>
</blockquote>
<hr>
<h3 id="2-기본-서버-작업"><a href="#2-기본-서버-작업" class="headerlink" title="2. 기본 서버 작업"></a>2. 기본 서버 작업</h3><h4 id="2-1-collection-작성"><a href="#2-1-collection-작성" class="headerlink" title="2.1 collection 작성"></a>2.1 collection 작성</h4><p>이번 예제에 사용할 콜랙션은 posts라는 단일 콜랙션을 사용할 것입니다. 다음을 참고로 해당 콜랙션을 만들어 주세요. 참고로 Meteor에서의 콜랙션은 일종의 데이터베이스에서의 테이블에 해당하는 부분입니다. Meteor에서는 collection설정을 통해 서버의 몽고디비와 클라이언트의 미니몽고를 연동해줍니다. 이부분은 다른 강좌에서 좀더 깊이있게 다루도록 하겠습니다. 간단하게는 일종의 데이터베이스 설정? 정도로 이해해 주시면 되겠습니다. </p>
<p><code>lib/collections.js</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Posts = new Mongo.Collection(&apos;posts&apos;);</div></pre></td></tr></table></figure></p>
<h4 id="2-2-pubs-작성"><a href="#2-2-pubs-작성" class="headerlink" title="2.2 pubs 작성"></a>2.2 pubs 작성</h4><p>pubs는 Meteor에서 데이터 베이스의 내용을 가져오는 방법중에 하나입니다. pub(발행)/sub(구독)이라는 메커니즘을 통해서 필요한 데이터를 몽고디비에서 미니몽고로 받아오는 구조입니다. 이부분도 나중에 다른 강좌를 통해서 조금더 자세히 다루도록 하겠습니다. </p>
<p>우선 <code>posts</code>는 리스트를 뿌려주는 일종의 쿼리부분이 되겠습니다. 일반 데이터베이스 였다면 <code>select 컬럼들 from 테이블 limit 보여줄 개수</code> 정도의 쿼리를 호출한다고 생각하시면 되겠습니다. </p>
<p>다음으로 <code>postDetail</code>은 리스트에서 선택된 post의 내용을 보여주는 부분입니다.<br><code>select 컬럼들 from 테이블명 where id=id</code> 이런 식의 쿼리에 해당하는 내용입니다. </p>
<p>이제 아래 코드를 입력해 주세요.</p>
<p><code>server/pubs.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Meteor.publish(&apos;posts&apos;, function (postCnt) &#123;</div><div class="line">  return Posts.find(&#123;&#125;, &#123;limit: postCnt, sort: &#123;postDate: -1&#125;&#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">Meteor.publish(&apos;postDetail&apos;, function (id) &#123;</div><div class="line">  return Posts.find(&#123;_id: id&#125;); // 여기서 findOne를 사용하면 두번 리턴되는 문제 발생</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="2-3-methods-작성"><a href="#2-3-methods-작성" class="headerlink" title="2.3 methods 작성"></a>2.3 methods 작성</h4><p>method는 pub/sub과 함께 데이터베이스를 다루는 방법입니다. pub/sub이 리스트 형식의 데이터를 가져오는데 주로 사용된다면, method는 쓰기, 수정, 삭제에 주로 사용됩니다.<br>여기서는 <code>select count(id) from 테이블</code>에 해당하는 쿼리를 처리하기 위해 사용했습니다. </p>
<p><code>lib/methods/postMethods.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Meteor.methods(&#123;</div><div class="line"></div><div class="line">  getPostCountAll: function () &#123;</div><div class="line">    return Posts.find().count();</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<hr>
<h3 id="3-라우팅-세팅"><a href="#3-라우팅-세팅" class="headerlink" title="3. 라우팅 세팅"></a>3. 라우팅 세팅</h3><p>라우팅에 대해 간단히 설명드리면 <code>http://localhost:3000/postList</code> 주소로 url을 입력하면 <code>postList</code>라는 template이 <code>mainLayout</code>이라는 곳에 보여 진다는 의미를 가집니다. 다시 설명 하자면, url주소에 따라 postList, postView 등의 페이지로 이동하게 하는 기능이 되겠습니다.  </p>
<p>라우팅될 페이지는 총 2개의 페이지가 되겠습니다. <code>/postList</code>는 무한스크롤 페이지가 되겠고, <code>/postView</code>는 리스트에서 선택된 목록의 내용을 보는 페이지가 되겠습니다. 그리고 <code>/</code> 의 경우는 아이피 주소로 처음 접근한 사용자를 리스트 페이지로 보내주도록 하는 기능입니다. </p>
<p>postView의 경우 <code>:id</code>로 표시되는 부분이 있는데요. 이부분은 상세보기 페이지의 id 값이 되겠습니다. 리스트에서 <code>a href</code>로 링크를 걸어줄때 <code>http://localhost:3000/postView/iFcDNXidApCtyCFRt</code> 이런 형태의 주소가 될텐데요. 여기서 <code>postView/</code> 뒤에 있는 값이 ID값이라고 인식시켜 주는 방법입니다. 그리고 이 키 값을 <code>var id = FlowRouter.getParam(&#39;id&#39;);</code> 이런 식으로 변수에 담아 사용 할 수 있습니다. </p>
<p>이제 routes.js를 열고 다음을 입력해 주세요. </p>
<p><code>lib/routes.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">FlowRouter.route(&apos;/&apos;, &#123;</div><div class="line">  name: &apos;main&apos;,</div><div class="line">  action: function() &#123;</div><div class="line"></div><div class="line">    FlowRouter.go(&apos;/postList&apos;);</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">FlowRouter.route(&apos;/postList&apos;, &#123;</div><div class="line">  name: &apos;main&apos;,</div><div class="line">  action: function() &#123;</div><div class="line"></div><div class="line">    BlazeLayout.render(&apos;mainLayout&apos;, &#123;</div><div class="line">      content:&apos;postList&apos;</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">FlowRouter.route(&apos;/postView/:id&apos;, &#123;</div><div class="line">  name: &apos;postView&apos;,</div><div class="line">  action: function () &#123;</div><div class="line"></div><div class="line">    var id = FlowRouter.getParam(&apos;id&apos;);</div><div class="line"></div><div class="line">    BlazeLayout.render(&apos;mainLayout&apos;, &#123;</div><div class="line">      content: &apos;postView&apos;</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>다음은 위에 잠시 설명한 주소에 따라 템플릿을 뿌려줄 일종의 부모 템플릿을 설정하는 파일이 되겠습니다. client/main-layout.js 에 파일을 만들고 내용을 입력해 주세요.</p>
<p><code>client/main-layout.html</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&lt;template name=&quot;mainLayout&quot;&gt;</div><div class="line">  &lt;header class=&quot;navbar navbar-default navbar-fixed-top table-header-bg&quot; &gt;</div><div class="line">    &lt;div class=&quot;container &quot;&gt;</div><div class="line"></div><div class="line">      &lt;div class=&quot;navbar-header&quot;&gt;</div><div class="line">        &lt;a href=&quot;/&quot; class=&quot;navbar-brand&quot; name=&quot;btn-home&quot;&gt;Infinite Scroll&lt;/a&gt;</div><div class="line">      &lt;/div&gt;</div><div class="line"></div><div class="line">      &lt;div class=&quot;collapse navbar-collapse navbar-right navbar-ex1-collapse&quot;&gt;</div><div class="line">        &lt;div class=&quot;navbar-form navbar-right&quot; ng-controller=&quot;authCtrl as auth &quot;&gt;</div><div class="line"></div><div class="line">        &lt;/div&gt;</div><div class="line">      &lt;/div&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line"></div><div class="line">  &lt;/header&gt;</div><div class="line">  &lt;div class=&quot;container&quot;&gt;</div><div class="line">    &#123;&#123;&gt; Template.dynamic template=content &#125;&#125;</div><div class="line">  &lt;/div&gt;</div><div class="line">&lt;/template&gt;</div></pre></td></tr></table></figure>
<hr>
<h3 id="4-리스트-및-내용보기-페이지-작성"><a href="#4-리스트-및-내용보기-페이지-작성" class="headerlink" title="4. 리스트 및 내용보기 페이지 작성"></a>4. 리스트 및 내용보기 페이지 작성</h3><h4 id="4-1-포스트-리스트"><a href="#4-1-포스트-리스트" class="headerlink" title="4.1 포스트 리스트"></a>4.1 포스트 리스트</h4><p>이제 리스트 페이지를 작성해 보도록 하겠습니다.<br>우선 이번프로젝트에 사용할 css 파일을 작성하도록 하겠습니다. 다음 링크의 css파일의 내용을 복사해 주세요.</p>
<p><code>client/styles/main.css</code></p>
<blockquote>
<p><a href="https://github.com/freeseamew/meteor-infinit-scroll/blob/master/client/styles/main.css" target="_blank" rel="noopener">https://github.com/freeseamew/meteor-infinit-scroll/blob/master/client/styles/main.css</a></p>
</blockquote>
<p>다음으로 아래를 참고로 <code>post-list.html</code> 파일을 만들겠습니다. 이 파일에는 postList, postListItem, postLoadingItem 의 3가지 template을 사용할 예정입니다. 참고로 Meteor는 기본적으로 blaze라는 프론트엔드 엔진을 사용하는데, <code>post-list.html, post-list.js</code> 이런 식으로 동일 템플릿에 해당하는 html과 이 템플릿에 대응하는 js 파일로 이루어 지는 구조입니다. </p>
<p>코드를 설명드리면 <code>#each list</code> 에 해당하는 부분은 list라는 데이터를 each문을 사용해서 <code>&gt;postListItem</code> 이 템플릿을 반복시켜 주는 기능을 합니다. 그리고 <code>#if endOfData</code> 에서는 만약 뿌려줄 리스트가 더이상 없을 경우  마지막 페이지라는 것을 표시해줍니다. 또 <code>#if postLoadingEffect</code> 와 <code>#unless Template.subscriptionsReady</code>는 데이터가 로딩중이거나, 템플릿이 준비가 완료되지 않을 경우 로딩 효과를 불러오는 역할을 합니다. </p>
<p><code>client/contents/post-lists.html</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">&lt;template name=&quot;postList&quot;&gt;</div><div class="line"></div><div class="line">  &lt;div class=&quot;row margin-top-20&quot;&gt;</div><div class="line">    &lt;div class=&quot;col-xs-12 col-md-12 table-border tableHeight padding-0 &quot; &gt;</div><div class="line"></div><div class="line">      &lt;table class=&quot;table&quot; &gt;</div><div class="line">        &lt;thead class=&quot; table-header-bg&quot;&gt;</div><div class="line">          &lt;tr&gt;</div><div class="line">            &lt;th class=&quot;tb-title&quot;&gt;제목&lt;/th&gt;</div><div class="line">            &lt;th class=&quot;align-center tb-user&quot;&gt;사용자&lt;/th&gt;</div><div class="line">            &lt;th class=&quot;align-center tb-view&quot;&gt;조회&lt;/th&gt;</div><div class="line">            &lt;th class=&quot;align-center tb-comment&quot;&gt;댓글&lt;/th&gt;</div><div class="line">            &lt;th class=&quot;align-centr tb-recommend&quot;&gt;추천&lt;/th&gt;</div><div class="line">            &lt;th class=&quot;align-right tb-date&quot;&gt;날짜&lt;/th&gt;</div><div class="line">          &lt;/tr&gt;</div><div class="line">        &lt;/thead&gt;</div><div class="line">        &lt;tbody id=&quot;tableBoardList&quot; ss&gt;</div><div class="line">        &#123;&#123;#each list&#125;&#125;</div><div class="line">          &#123;&#123;&gt;postListItem&#125;&#125;</div><div class="line">        &#123;&#123;/each&#125;&#125;</div><div class="line"></div><div class="line">        &#123;&#123;#if endOfData&#125;&#125;</div><div class="line">          &lt;p&gt;더이상 데이터가 없습니다.&lt;/p&gt;</div><div class="line">        &#123;&#123;/if&#125;&#125;</div><div class="line"></div><div class="line">        &lt;/tbody&gt;</div><div class="line">      &lt;/table&gt;</div><div class="line">      &#123;&#123;#if postLoadingEffect&#125;&#125;</div><div class="line">        &#123;&#123;&gt;postLoadingItem&#125;&#125;</div><div class="line">      &#123;&#123;/if&#125;&#125;</div><div class="line"></div><div class="line">      &#123;&#123;#unless Template.subscriptionsReady&#125;&#125;</div><div class="line">        &#123;&#123;&gt;postLoadingItem&#125;&#125;</div><div class="line">      &#123;&#123;/unless&#125;&#125;</div><div class="line">    &lt;/div&gt;</div><div class="line"></div><div class="line">  &lt;/div&gt;</div><div class="line">&lt;/template&gt;</div></pre></td></tr></table></figure>
<p>다음은 같은 파일에 리스트 내용에 해당하는 템플릿을 만들어 보겠습니다. 위에서 설명드린 each를 통해 반복되면서 표시되는 리스트의 내용이라고 보시면 되겠습니다. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">.</div><div class="line">.</div><div class="line">.</div><div class="line">[위 상략]</div><div class="line"></div><div class="line">&lt;template name=&quot;postListItem&quot;&gt;</div><div class="line">  &lt;tr id=&quot;my-infinite-scrolling-list&quot; pageCnt=&quot;&#123;&#123;pageCnt&#125;&#125;&quot; &gt;</div><div class="line">    &lt;td class=&quot;tb-title&quot;&gt;&lt;p&gt;&lt;a href=&quot;&#123;&#123;pathFor &apos;/postView/:id&apos; id=_id&#125;&#125;&quot; name=&quot;#&#123;&#123;_id&#125;&#125;&quot; class=&quot;goView&quot; &gt;&#123;&#123;postTitle&#125;&#125;&lt;/a&gt;&lt;/p&gt;&lt;/td&gt;</div><div class="line">    &lt;td class=&quot;align-center tb-user&quot;&gt;&lt;p&gt;&lt;a href=&quot;&#123;&#123;pathFor &apos;/postView/:id&apos; id=_id&#125;&#125;&quot; class=&quot;goView&quot;&gt;&#123;&#123;postUserName&#125;&#125;&lt;/a&gt;&lt;/p&gt;&lt;/td&gt;</div><div class="line">    &lt;td class=&quot;align-center tb-view&quot;&gt;&lt;p&gt;&lt;a href=&quot;&#123;&#123;pathFor &apos;/postView/:id&apos; id=_id&#125;&#125;&quot; class=&quot;goView&quot;&gt;&#123;&#123;postViewCount&#125;&#125;&lt;/a&gt;&lt;/p&gt;&lt;/td&gt;</div><div class="line">    &lt;td class=&quot;align-center tb-comment&quot;&gt;&lt;p&gt;&lt;a href=&quot;&#123;&#123;pathFor &apos;/postView/:id&apos; id=_id&#125;&#125;&quot; class=&quot;goView&quot;&gt;&#123;&#123;postCommentCount&#125;&#125;&lt;/a&gt;&lt;/p&gt;&lt;/td&gt;</div><div class="line">    &lt;td class=&quot;align-center tb-recommend&quot;&gt;&lt;p&gt;&lt;a href=&quot;&#123;&#123;pathFor &apos;/postView/:id&apos; id=_id&#125;&#125;&quot; class=&quot;goView&quot;&gt;&#123;&#123;postLikeCount&#125;&#125;&lt;/a&gt;&lt;/p&gt;&lt;/td&gt;</div><div class="line">    &lt;td class=&quot;align-right tb-date&quot;&gt;&lt;p&gt;&lt;a href=&quot;&#123;&#123;pathFor &apos;/countTest&apos;&#125;&#125;&quot; class=&quot;goView&quot;&gt;&#123;&#123;postDate&#125;&#125;&lt;/a&gt;&lt;/p&gt;&lt;/td&gt;</div><div class="line">  &lt;/tr&gt;</div><div class="line">&lt;/template&gt;</div></pre></td></tr></table></figure>
<p>마지막 템플릿은 로딩효과를 표시해줄 템플릿 입니다. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">.</div><div class="line">.</div><div class="line">.</div><div class="line">[위 상략]</div><div class="line"></div><div class="line">&lt;template name=&quot;postLoadingItem&quot;&gt;</div><div class="line">  &lt;div class=&quot;loading-bar&quot;&gt;</div><div class="line">    &lt;div class=&quot;loader&quot;&gt;&lt;/div&gt;</div><div class="line">  &lt;/div&gt;</div><div class="line">&lt;/template&gt;</div><div class="line"></div><div class="line"></div><div class="line">`client/contents/post-lists.html`</div></pre></td></tr></table></figure>
<p>이제 템플릿을 제어할 js 파일을 만들어 보도록 하겠습니다. 우선 <code>Template.postList.onCreated(function () {</code> 안의 내용을 작성하겠습니다. 각 내용에 필요한 부분들은 주석을 통해 설명해 두었습니다. 사실 ReactiveVar나 pub/sub에 관한 자세한 내용은 나중에 따로 강좌를 만들어 설명해 드리도록 하겠습니다. 하지만 작동 원리에 대한 시나리오는 간단히 설명드리겠습니다. </p>
<p> <code>self.autorun(function () {}</code>안에 정의된 <code>self.subscribe(&#39;posts&#39;, postCnt.get());</code>가 이 시스템의 가장 핵심적인 부분입니다. Meteor는 절차적인 방식과 함께 선언적인 방식을 함께 지원하는 플랫폼 입니다. 여기서의 pub/sub 을 사용하는 방법은 선언적인 방식을 이용해 페이징을 구현한 부분입니다. 만약 일반적인 절차적인 방식으로 게시글의 리스트를 불러온다면 페이지를 추가로 불러올 부분에서 데이터베이스를 호출할 function을 호출하는 방법으로 작동이 될 것입니다. 하지만, 여기서는  <code>self.subscribe(&#39;posts&#39;, postCnt.get());</code> 이렇게 선언을 해주고 페이지를 늘려야 하는 경우 <code>postCnt.set(postCnt.get() + 10);</code> 이런식으로 postCnt만 조정해주면 서버에서 필요한 부분만 추가되는 식으로 작동합니다. 즉 subscribe를 선언해두고 Reactivar로 정의된 부분만 변경해 주면 위치에 상관없이 리스트의 데이터가 변화된다고 생각하시면 되겠습니다. 일단 이부분에 대한 제 강좌가 없으므로 다음 링크를 통해 간단하게 나마 원리를 보실 수 있을 것입니다. </p>
<blockquote>
<p>링크 : <a href="http://kr.discovermeteor.com/chapters/publications-and-subscriptions/" target="_blank" rel="noopener">pub/sub 설명</a></p>
</blockquote>
<p><code>client/contents/post-lists.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">Template.postList.onCreated(function () &#123;</div><div class="line"></div><div class="line">  window.postCountAll = new ReactiveVar(0);  // post의 총 개수를 저장할 저장소</div><div class="line">  window.postLoadingEffect = new ReactiveVar(false); // 로딩 효과를 나타낼지 말지를 결정할 저장소</div><div class="line">  window.scrollRock = new ReactiveVar(false); // 스크롤바가 로딩중에는 더이상 추가로딩을 하지 않도록 할 저장소</div><div class="line">  window.postCnt = new ReactiveVar(20); // 불러올 포스트 개수 세팅</div><div class="line"></div><div class="line">  var self = this;</div><div class="line"></div><div class="line">  Meteor.call(&apos;getPostCountAll&apos;, function (err, result) &#123;</div><div class="line">    if(err) &#123;</div><div class="line">      console.log(err.message);</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">      return postCountAll.set(result); // 포스트 개수를 method에서 불러와 postCountAll에 저장.</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  self.autorun(function () &#123;</div><div class="line">    self.subscribe(&apos;posts&apos;, postCnt.get()); // posts 리스트를 불로올 posts pub를 호출</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  window.onscroll = function (ev) &#123;</div><div class="line">    if ((window.innerHeight + window.scrollY) &gt;= document.body.offsetHeight) &#123; // 스크롤이 바닥에 닿으면 다음 페이지 진행</div><div class="line"></div><div class="line">      if(!(postCountAll.get() &lt; postCnt.get()) &amp;&amp; scrollRock.get() === false ) &#123; // 페이지가 끝나지 않았거나 로딩중이 아닐때에만 페이지수를 증가하는 이벤트 발생</div><div class="line"></div><div class="line">        scrollRock.set(true); // 페이지 증가 전에 scrollRock을 true로 해서 잠금.</div><div class="line"></div><div class="line">        postLoadingEffect.set(true);</div><div class="line">        Meteor.setTimeout(function () &#123;</div><div class="line">          postLoadingEffect.set(false);</div><div class="line">          scrollRock.set(false);</div><div class="line">        &#125;, 1000);</div><div class="line"></div><div class="line">        postCnt.set(postCnt.get() + 10); // 패아자룰 10개 증가 시켜 줌.</div><div class="line">        console.log(&apos;postCnt: &apos; + postCnt.get()); // 페이지에 대한 로그</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>다음은 <code>Template.postList.helpers({})</code> 로 템플릿에 데이터를 전달하는 부분입니다. </p>
<p><code>list</code>는 리스트에 뿌려질 포스트 목록 데이터 입니다. <code>endOfData</code>는 현재 불러온 포스트 개수가 전체 포스트 개수보다 크거나 같으면 false를 리턴해 더이상 페이지 증가 이벤트가 작동하지 않도록 하는 역할을 합니다. <code>postLoadingEffect</code>는 true일 경우 로딩을 보여줄지 말지에 대한 true, false를 나타내는 역할을 합니다. </p>
<p><code>client/contents/post-lists.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Template.postList.helpers(&#123;</div><div class="line">  list: function () &#123;</div><div class="line">    return Posts.find(&#123;&#125;, &#123;sort: &#123;postDate: -1&#125;&#125;);</div><div class="line">  &#125;,</div><div class="line">  endOfData : function () &#123;</div><div class="line">    return postCountAll.get() &lt; postCnt.get() ? true : false;</div><div class="line">  &#125;,</div><div class="line">  postLoadingEffect: function () &#123;</div><div class="line">    return postLoadingEffect.get();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="4-2-포스트-내용보기"><a href="#4-2-포스트-내용보기" class="headerlink" title="4.2 포스트 내용보기"></a>4.2 포스트 내용보기</h4><p>다음은 내용보기 입니다. 리스트의 링크를 클릭하면 선택된 리스트의 내용을 보여주는 페이지가 되겠습니다.<br>우선 템플릿부터 작성하도록 하겠습니다. </p>
<p><code>client/contents/post-view.html</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&lt;template name=&quot;postView&quot;&gt;</div><div class="line">  &#123;&#123;#with contentView &#125;&#125;</div><div class="line">    &lt;div class=&quot;row margin-top-20&quot;&gt;</div><div class="line">      &lt;div class=&quot;col-xs-12 col-md-12 &quot; &gt;</div><div class="line"></div><div class="line">        &lt;div class=&quot;content-wrap&quot;&gt;</div><div class="line">          &lt;div class=&quot;post-content-top&quot;&gt;</div><div class="line">            &lt;h1&gt;&#123;&#123;postTitle&#125;&#125;&lt;/h1&gt;</div><div class="line">          &lt;/div&gt;</div><div class="line">          &lt;div class=&quot;post-content-top&quot;&gt;</div><div class="line">            &lt;p&gt;&#123;&#123;postUserName&#125;&#125;&lt;/p&gt;</div><div class="line">            &lt;p class=&quot;post-date&quot;&gt;&#123;&#123;postDate&#125;&#125;&lt;/p&gt;</div><div class="line">          &lt;/div&gt;</div><div class="line">          &lt;div class=&quot;post-content-middle&quot;&gt;</div><div class="line">            &#123;&#123;&#123;postContent&#125;&#125;&#125;</div><div class="line">          &lt;/div&gt;</div><div class="line"></div><div class="line">        &lt;/div&gt;</div><div class="line">      &lt;/div&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line"></div><div class="line">  &#123;&#123;/with&#125;&#125;</div><div class="line">&lt;/template&gt;</div></pre></td></tr></table></figure>
<p>그리고 대응하는 js 파일을 작성합니다. post-list보다는 단순하지만 구조는 비슷합니다.   <code>self.subscribe(&#39;postDetail&#39;, postIdSet.get());</code>를 선언하고 postIdSet을 받아 내용을 전달하는 것이 전부입니다. 참고로 postIdSet은 route에서 전달받고 있습니다. (위에 라우팅 부분 참고)</p>
<p><code>client/contents/post-view.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Template.postView.onCreated(function () &#123;</div><div class="line"></div><div class="line">  var self = this;</div><div class="line"></div><div class="line">  self.autorun(function ()</div><div class="line">  &#123;</div><div class="line">    self.subscribe(&apos;postDetail&apos;, postIdSet.get());</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">&#125;);</div><div class="line"></div><div class="line">Template.postView.helpers(&#123;</div><div class="line"></div><div class="line">  contentView: function()</div><div class="line">  &#123;</div><div class="line">    var postOne = Posts.findOne(&#123;_id: postIdSet.get()&#125;);</div><div class="line">    return postOne;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="4-3-데이터-주입"><a href="#4-3-데이터-주입" class="headerlink" title="4.3 데이터 주입"></a>4.3 데이터 주입</h4><p>이제 기본적인 페이지들은 모두 만들었습니다. 다음으로 해야할 일은 리스트로 사용할 데이터를 주입하는 일입니다.<br>코드를 설명드리면 Meteor가 시작될 때 디비에 데이터가 없으면 fixture를 for 문으로 돌면서 데이터베이스에 주입하는 소스입니다. 다음 링크에서 소스를 복사해 사용하시면 되겠습니다. </p>
<blockquote>
<p>링크 : <a href="https://github.com/freeseamew/meteor-infinit-scroll/blob/master/server/fixture.js" target="_blank" rel="noopener">fixture.js</a></p>
</blockquote>
<p><code>server/fixture.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">var fixture = [</div><div class="line"></div><div class="line">.</div><div class="line">.</div><div class="line">.</div><div class="line">데이터</div><div class="line">.</div><div class="line">.</div><div class="line">.</div><div class="line"></div><div class="line">]</div><div class="line"></div><div class="line">Meteor.startup(() =&gt; &#123;</div><div class="line">  if(Posts.find().count() === 0) &#123;</div><div class="line">    console.log(&apos;데이터가 존재하지 않습니다 fixture 데이터를 입력합니다.&apos;);</div><div class="line"></div><div class="line">    for(var i=0, len=250; i&lt;len; i++) &#123;</div><div class="line">      Posts.insert((fixture[i]));</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>이제 터미널 창에서 다음 명령을 실행해 서버를 실행해 보겠습니다. 정상적으로 작동한다면, <code>http://localhost:3000</code> 로 페이지에 접속할 수 있을 것입니다. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">meteor run</div></pre></td></tr></table></figure>
<p>여기까지는 무한스크롤을 구성하는 강좌였습니다. 이어서 바로 다음 강좌에서는 무한스크롤의 문제점과 그 해결방안에 대해서 다루어 보도록 하겠습니다. </p>
<blockquote>
<p>소스코드 링크<br><a href="https://github.com/freeseamew/meteor-infinit-scroll" target="_blank" rel="noopener">https://github.com/freeseamew/meteor-infinit-scroll</a></p>
</blockquote>
</div></article></div></main><footer><div class="paginator"><a class="next" href="/2017/12/02/meteor-Infinite-scroll-2/">NEXT</a></div><div class="fb-comments" data-href="http://freeseamew.github.io/2017/12/02/meteor-Infinite-scroll-1/" data-width="700" data-numposts="5"></div><div id="disqus_thread"></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>window.fbAsyncInit=function(){FB.init({appId:"1765163213798195",cookie:!0,xfbml:!0,version:"v2.8"}),FB.AppEvents.logPageView()},function(e,n,t){var o,c=e.getElementsByTagName(n)[0];e.getElementById(t)||((o=e.createElement(n)).id=t,o.src="//connect.facebook.net/en_US/sdk.js",c.parentNode.insertBefore(o,c))}(document,"script","facebook-jssdk");</script></body></html>